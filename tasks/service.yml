---
- name: Symlink service logs folder
  file:
    src: '/var/log/service/{{ nimbus_portal_client_service_name }}'
    dest: '{{ nimbus_portal_client_logs_link }}'
    state: 'link'
    force: true

- name: Get finalized header data from Nimbus mainnet beacon API
  uri:
    url: "{{ nimbus_portal_client_mainnet_beacon_api_endpoint }}"
    method: GET
    return_content: yes
  register: response

- name: Extract trusted block root and set as a variable
  set_fact:
    nimbus_portal_client_trusted_block_root: "{{ response.json | json_query('data.root') }}"

- name: Create systemd Unit file
  template:
    src: 'portal-client.service.j2'
    dest: '/etc/systemd/system/{{ nimbus_portal_client_service_name }}.service'
    mode: 0644
  register: nimbus_portal_client_service_definition

- name: Reload and restart the service
  systemd:
    name: '{{ nimbus_portal_client_service_name }}.service'
    enabled: true
    daemon_reload: true
    state: |-
      {{ nimbus_portal_client_service_definition.changed
       | ternary("restarted", "started") }}
